@using QuienEsJesus.Services

<div class="bible-search-container">
    <div class="bible-search-header">
        <h5 class="bible-search-title">
            <i class="bi bi-book-half"></i> Búsqueda Bíblica
        </h5>
    </div>
    
    <div class="bible-search-input-group">
        <input type="text" 
               class="form-control bible-search-input" 
               placeholder="Ej: Juan 3:16, Salmos 23, Romanos 8:28..."
               @bind="searchQuery"
               @bind:event="oninput"
               @onkeypress="HandleKeyPress" />
        <button class="btn btn-primary bible-search-btn" @onclick="SearchVerse" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            }
            else
            {
                <i class="bi bi-search"></i>
            }
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-warning mt-3 bible-alert">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
        </div>
    }

    @if (currentVerse != null)
    {
        <div class="bible-verse-card mt-3">
            <div class="bible-verse-reference">
                <span class="reference-spanish">@currentVerse.ReferenceSpanish</span>
                <span class="reference-english">(@currentVerse.Reference)</span>
            </div>
            <div class="bible-verse-text">
                @currentVerse.Text
            </div>
            <div class="bible-verse-footer">
                <span class="bible-translation">@currentVerse.Translation</span>
                @if (OnInsertVerse.HasDelegate)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="InsertVerseToEditor">
                        <i class="bi bi-plus-circle"></i> Insertar
                    </button>
                }
            </div>
        </div>
    }

    <div class="bible-suggestions mt-3">
        <small class="text-muted">Referencias populares:</small>
        <div class="suggestion-tags">
            @foreach (var reference in popularReferences.Take(6))
            {
                <button class="btn btn-sm btn-outline-secondary suggestion-tag" 
                        @onclick="@(() => QuickSearch(reference))">
                    @reference
                </button>
            }
        </div>
    </div>
</div>

<style>
    .bible-search-container {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border-top: 4px solid var(--color-primary);
    }

    .bible-search-header {
        margin-bottom: 1rem;
    }

    .bible-search-title {
        color: var(--color-primary);
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bible-search-title i {
        font-size: 1.25rem;
    }

    .bible-search-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .bible-search-input {
        flex: 1;
        border: 2px solid var(--color-gray-light);
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all var(--transition-fast);
    }

    .bible-search-input:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 4px rgba(176, 42, 41, 0.1);
        outline: none;
    }

    .bible-search-btn {
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-md);
        min-width: 50px;
    }

    .bible-verse-card {
        background: linear-gradient(135deg, var(--color-cream) 0%, var(--color-off-white) 100%);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        border-left: 4px solid var(--color-primary);
        position: relative;
    }

    .bible-verse-reference {
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: baseline;
    }

    .reference-spanish {
        font-weight: 700;
        font-size: 1.125rem;
        color: var(--color-primary);
    }

    .reference-english {
        font-size: 0.875rem;
        color: var(--color-gray);
    }

    .bible-verse-text {
        font-size: 1.1rem;
        line-height: 1.8;
        color: var(--color-dark);
        font-style: italic;
        margin-bottom: 1rem;
        padding-left: 1rem;
        border-left: 2px solid var(--color-secondary-light);
    }

    .bible-verse-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.75rem;
        border-top: 1px solid var(--color-gray-light);
    }

    .bible-translation {
        font-size: 0.8rem;
        color: var(--color-gray);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .bible-alert {
        font-size: 0.9rem;
    }

    .bible-suggestions {
        padding-top: 1rem;
        border-top: 1px dashed var(--color-gray-light);
    }

    .suggestion-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .suggestion-tag {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-sm);
        transition: all var(--transition-fast);
    }

    .suggestion-tag:hover {
        background: var(--color-primary);
        color: var(--color-cream);
        border-color: var(--color-primary);
    }

    @@media (max-width: 576px) {
        .bible-search-container {
            padding: 1rem;
        }

        .bible-verse-text {
            font-size: 1rem;
        }

        .bible-verse-footer {
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
        }
    }
</style>

@code {
    [Inject]
    private BibleService BibleService { get; set; } = default!;

    [Parameter]
    public EventCallback<string> OnInsertVerse { get; set; }

    private string searchQuery = string.Empty;
    private BibleVerseResult? currentVerse;
    private string? errorMessage;
    private bool isLoading = false;
    private List<string> popularReferences = new();

    protected override void OnInitialized()
    {
        popularReferences = BibleService.GetPopularReferences();
    }

    private async Task SearchVerse()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            errorMessage = "Por favor, ingresa una referencia bíblica.";
            return;
        }

        isLoading = true;
        errorMessage = null;
        currentVerse = null;
        StateHasChanged();

        try
        {
            currentVerse = await BibleService.GetVerseAsync(searchQuery);
            
            if (currentVerse == null)
            {
                errorMessage = "No se encontró la referencia. Intenta con formato: 'Juan 3:16' o 'John 3:16'";
            }
        }
        catch (Exception)
        {
            errorMessage = "Error al buscar el versículo. Verifica tu conexión a internet.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchVerse();
        }
    }

    private async Task QuickSearch(string reference)
    {
        searchQuery = reference;
        await SearchVerse();
    }

    private async Task InsertVerseToEditor()
    {
        if (currentVerse != null && OnInsertVerse.HasDelegate)
        {
            var formattedVerse = $"\n> \"{currentVerse.Text}\"\n> — {currentVerse.ReferenceSpanish} ({currentVerse.Translation})\n";
            await OnInsertVerse.InvokeAsync(formattedVerse);
        }
    }
}
